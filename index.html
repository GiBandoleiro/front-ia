<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatBot Builder Pro</title>
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;</script>


    <!-- Custom Tailwind Config -->
    <script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'system-ui', 'sans-serif'],
                },
                colors: {
                    base: {
                        DEFAULT: '#0F1115', // Dark bg
                        light: '#F9FAFB' // Light bg
                    },
                    card: {
                        DEFAULT: '#151922', // Dark card
                        light: '#FFFFFF'   // Light card
                    },
                    border: {
                        DEFAULT: '#242A36', // Dark border
                        light: '#E5E7EB'   // Light border
                    },
                    'primary-text': {
                        DEFAULT: '#E6EAF2', // Dark primary text
                        light: '#1F2937'   // Light primary text
                    },
                    'secondary-text': {
                        DEFAULT: '#A5B0C2', // Dark secondary text
                        light: '#6B7280'   // Light secondary text
                    },
                    primary: {
                        DEFAULT: '#0D94F1',
                        hover: '#25a6f2'
                    },
                    accent: '#22C55E',
                    link: '#60A5FA',
                    danger: '#EF4444',
                    warning: '#F59E0B',
                    'input-bg': {
                        DEFAULT: '#0F141C', // Dark input bg
                        light: '#F3F4F6' // Light input bg
                    },
                },
                borderRadius: {
                    '2xl': '1rem',
                    lg: '0.5rem',
                },
                boxShadow: {
                   '2xl': '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
                   'glow': '0 0 15px 0 rgba(13, 148, 241, 0.3)',
                },
                keyframes: {
                    bounce: {
                        '0%, 100%': { transform: 'translateY(-25%)', animationTimingFunction: 'cubic-bezier(0.8,0,1,1)' },
                        '50%': { transform: 'none', animationTimingFunction: 'cubic-bezier(0,0,0.2,1)' },
                    }
                }
            }
        }
    }
    </script>

    <!-- ES Module Shims for imports -->
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.10.0/dist/es-module-shims.js"></script>

    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { 
            background: var(--scrollbar-track-bg, #F3F4F6);
        }
        html.dark ::-webkit-scrollbar-track {
             --scrollbar-track-bg: #0F141C;
        }
        ::-webkit-scrollbar-thumb { 
            background: var(--scrollbar-thumb-bg, #D1D5DB); 
            border-radius: 4px; 
        }
        html.dark ::-webkit-scrollbar-thumb {
            --scrollbar-thumb-bg: #242A36;
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: var(--scrollbar-thumb-hover-bg, #9CA3AF);
        }
        html.dark ::-webkit-scrollbar-thumb:hover {
            --scrollbar-thumb-hover-bg: #3a4356;
        }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Style for selected agent */
        .agent-selected {
            outline: 2px solid #0D94F1;
            box-shadow: var(--tw-shadow-glow);
        }
        .footer-btn {
            @apply flex-1 sm:flex-initial flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold transition-colors bg-base-light dark:bg-base border border-border-light dark:border-border hover:bg-border-light/50 dark:hover:bg-border/50;
        }
    </style>
</head>
<body class="bg-base-light dark:bg-base text-primary-text-light dark:text-primary-text antialiased">
    <div id="root"></div>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.3.1",
            "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
            "zustand": "https://esm.sh/zustand@4.5.2",
            "zustand/middleware": "https://esm.sh/zustand@4.5.2/middleware",
            "lucide-react": "https://esm.sh/lucide-react@0.395.0",
            "sonner": "https://esm.sh/sonner@1.5.0"
        }
    }
    </script>

    <script type="module">
        import React from 'react';
        import ReactDOM from 'react-dom/client';
        import { create } from 'zustand';
        import { persist, createJSONStorage } from 'zustand/middleware';
        import {
            Bot, MessageSquare, Users, LineChart, Megaphone, HelpCircle, Settings, Sun, Moon,
            Search, Calculator, Mail, Calendar, Globe, Plus, ChevronDown, ChevronUp, Trash2,
            FileText, UploadCloud, Link, X, CornerDownLeft, Image as ImageIcon, Mic, Send, BotMessageSquare,
            BrainCircuit, Workflow, Copy, Check, CheckCircle, FileUp, MoreVertical, Edit, Copy as CopyIcon,
            ArrowRight, Circle, Package, MessageCircle as MessageCircleIcon, Code, Power, PowerOff, Sparkles,
            ListTodo, Star, UserPlus, Tags, SlidersHorizontal, LogIn, LogOut, Download, Sliders, Eye, FileJson, TestTube2, AlertTriangle, Book, FileQuestion, Terminal, ChevronsRight, Loader, Menu, Save
        } from 'lucide-react';
        import { Toaster, toast } from 'sonner';

        // --- ZUSTAND STORE SETUP ---
        const initialAgentState = {
            id: `sub_${Date.now()}`,
            name: "Novo Agente",
            type: 'sub_agent',
            prompt: "",
            specialty: "",
        };

        const initialMultiAgentState = (id) => ({
            id: id,
            name: "Multi-Agente Padrão",
            type: 'multi_agent',
            prompt: "Você é um multi-agente avançado. Sua função é analisar a conversa do usuário e direcioná-la para o sub-agente mais apropriado.",
            specialty: "Orquestrador de agentes",
            subAgents: [],
            knowledgeBase: [],
            tools: [
                { id: 'tool_web_search', name: 'Busca na Web', description: "Permite ao chatbot buscar informações na internet.", enabled: false, assignedAgents: [], config: { description: '', provider: 'Google', maxResults: 3, safeSearch: true } },
                { id: 'tool_calculator', name: 'Calculadora', description: "Realiza cálculos matemáticos e conversões.", enabled: false, assignedAgents: [], config: { description: '', precision: 2, useComplex: false } },
                { id: 'tool_email', name: 'Envio de Email', description: "Envia emails automáticos baseados na conversa.", enabled: false, assignedAgents: [], config: { description: '', sender: 'bot@example.com', subject: 'Assunto Automático' } },
                { id: 'tool_scheduling', name: 'Agendamento', description: "Agenda compromissos e consulta disponibilidade.", enabled: false, assignedAgents: [], config: { description: '', duration: 30, confirmationMsg: 'Sua reunião está agendada.'} },
                { id: 'tool_api', name: 'Integração API', description: "Conecta com APIs externas para dados em tempo real.", enabled: false, assignedAgents: [], config: { description: '', method: 'GET', url: 'https://api.example.com/data', timeout: 5000 } },
            ],
            outputs: [],
            keywords: { ignore: false, list: ['vendas', 'suporte', 'preço', 'ajuda'], actions: {} },
            channels: ['WhatsApp', 'WebChat'],
        });

        const useAppStore = create(
            persist(
                (set, get) => ({
                    multiAgents: [initialMultiAgentState(`multi_${Date.now()}`)],
                    activeAgentId: `multi_${Date.now()}`,
                    activeTab: 'config',
                    theme: 'dark',
                    previewState: {},
                    isSidebarOpen: false,

                    toggleSidebar: () => set(state => ({ isSidebarOpen: !state.isSidebarOpen })),
                    setActiveTab: (tab) => set({ activeTab: tab }),
                    
                    getOrCreatePreviewState: (agentId) => {
                        const state = get().previewState;
                        if (!state[agentId]) {
                            return { chat: [], logs: [] };
                        }
                        return state[agentId];
                    },

                    addChatMessage: (agentId, message) => set(state => {
                        const agentPreview = state.getOrCreatePreviewState(agentId);
                        return {
                            previewState: {
                                ...state.previewState,
                                [agentId]: { ...agentPreview, chat: [...agentPreview.chat, message] }
                            }
                        }
                    }),
                    
                    addLogMessage: (agentId, log) => set(state => {
                        const agentPreview = state.getOrCreatePreviewState(agentId);
                        const newLog = { id: `log_${Date.now()}`, ...log };
                        return {
                            previewState: {
                                ...state.previewState,
                                [agentId]: { ...agentPreview, logs: [...agentPreview.logs, newLog] }
                            }
                        }
                    }),

                    clearChat: (agentId) => set(state => {
                        const agentPreview = state.getOrCreatePreviewState(agentId);
                        return {
                             previewState: {
                                ...state.previewState,
                                [agentId]: { ...agentPreview, chat: [], logs: [] }
                            }
                        }
                    }),

                    toggleTheme: () => set(state => {
                        const newTheme = state.theme === 'dark' ? 'light' : 'dark';
                        if (newTheme === 'dark') {
                            document.documentElement.classList.add('dark');
                        } else {
                            document.documentElement.classList.remove('dark');
                        }
                        return { theme: newTheme };
                    }),

                    setActiveAgentId: (id) => set(state => {
                        if (window.innerWidth < 1024) { // lg breakpoint
                           return { activeAgentId: id, isSidebarOpen: false };
                        }
                        return { activeAgentId: id };
                    }),
                    addMultiAgent: () => set(state => {
                        const newId = `multi_${Date.now()}`;
                        return { 
                            multiAgents: [...state.multiAgents, initialMultiAgentState(newId)],
                            activeAgentId: newId 
                        };
                    }),
                    updateAgentConfig: (agentId, key, value) => set(state => {
                        const newMultiAgents = JSON.parse(JSON.stringify(state.multiAgents));
                        let agentFound = false;
                        for (const ma of newMultiAgents) {
                            if (ma.id === agentId) {
                                ma[key] = value; agentFound = true; break;
                            }
                            const subAgentIndex = ma.subAgents.findIndex(sa => sa.id === agentId);
                            if (subAgentIndex !== -1) {
                                ma.subAgents[subAgentIndex][key] = value; agentFound = true; break;
                            }
                        }
                        return { multiAgents: newMultiAgents };
                    }),
                    addSubAgent: (multiAgentId) => set(state => {
                        const newMultiAgents = JSON.parse(JSON.stringify(state.multiAgents));
                        const multiAgent = newMultiAgents.find(ma => ma.id === multiAgentId);
                        if (multiAgent) {
                            multiAgent.subAgents.push({ ...initialAgentState, id: `sub_${Date.now()}` });
                        }
                        return { multiAgents: newMultiAgents };
                    }),
                    deleteAgent: (agentId) => set(state => {
                        let newMultiAgents = JSON.parse(JSON.stringify(state.multiAgents));
                        let newActiveId = state.activeAgentId;
                        if (agentId.startsWith('multi_')) {
                           newMultiAgents = newMultiAgents.filter(ma => ma.id !== agentId);
                           if (state.activeAgentId === agentId) newActiveId = newMultiAgents.length > 0 ? newMultiAgents[0].id : null;
                        } else {
                            for (const ma of newMultiAgents) {
                                const initialLength = ma.subAgents.length;
                                ma.subAgents = ma.subAgents.filter(sa => sa.id !== agentId);
                                if (ma.subAgents.length < initialLength) {
                                    if(state.activeAgentId === agentId) newActiveId = ma.id;
                                    break;
                                }
                            }
                        }
                        if (newMultiAgents.length === 0) {
                            const newId = `multi_${Date.now()}`;
                            newMultiAgents.push(initialMultiAgentState(newId));
                            newActiveId = newId;
                        }
                        return { multiAgents: newMultiAgents, activeAgentId: newActiveId };
                    }),
                    renameAgent: (agentId, newName) => get().updateAgentConfig(agentId, 'name', newName),
                    duplicateAgent: (agentId) => set(state => {
                        const newMultiAgents = JSON.parse(JSON.stringify(state.multiAgents));
                        if(agentId.startsWith('multi_')) {
                            const original = state.multiAgents.find(ma => ma.id === agentId);
                            if (original) {
                                const newId = `multi_${Date.now()}`;
                                const duplicate = { ...original, id: newId, name: `${original.name} (Cópia)` };
                                duplicate.subAgents = duplicate.subAgents.map(sa => ({...sa, id: `sub_${Date.now()}_${Math.random()}`}));
                                newMultiAgents.push(duplicate);
                            }
                        } else {
                             for (const ma of newMultiAgents) {
                                const original = ma.subAgents.find(sa => sa.id === agentId);
                                if (original) {
                                    ma.subAgents.push({ ...original, id: `sub_${Date.now()}`, name: `${original.name} (Cópia)` });
                                    break;
                                }
                            }
                        }
                        return { multiAgents: newMultiAgents };
                    }),
                    updateMultiAgentConfig: (multiAgentId, key, value) => set(state => ({
                        multiAgents: state.multiAgents.map(ma => ma.id === multiAgentId ? { ...ma, [key]: value } : ma)
                    })),
                }),
                { name: 'chatbot-builder-storage', storage: createJSONStorage(() => localStorage) }
            )
        );
        
        const Icon = ({ name, ...props }) => {
            const LucideIcon = {
                bot: Bot, botMessage: BotMessageSquare, message: MessageSquare, users: Users, chart: LineChart,
                megaphone: Megaphone, help: HelpCircle, settings: Settings, sun: Sun, moon: Moon, search: Search,
                calculator: Calculator, mail: Mail, calendar: Calendar, globe: Globe, plus: Plus, down: ChevronDown,
                up: ChevronUp, trash: Trash2, file: FileText, upload: UploadCloud, link: Link, x: X, enter: CornerDownLeft,
                image: ImageIcon, mic: Mic, send: Send, brain: BrainCircuit, workflow: Workflow, copy: Copy,
                check: Check, checkCircle: CheckCircle, fileUp: FileUp, more: MoreVertical, edit: Edit, copyIcon: CopyIcon,
                arrowRight: ArrowRight, circle: Circle, package: Package, messageCircle: MessageCircleIcon, code: Code,
                power: Power, powerOff: PowerOff, sparkles: Sparkles, checklist: ListTodo, star: Star, userPlus: UserPlus,
                tags: Tags, sliders: SlidersHorizontal, login: LogIn, logout: LogOut, download: Download, config: Sliders, 
                eye: Eye, fileJson: FileJson, testTube: TestTube2, alert: AlertTriangle, book: Book, faq: FileQuestion,
                terminal: Terminal, chevronsRight: ChevronsRight, loader: Loader, menu: Menu, save: Save
            }[name];
            return LucideIcon ? React.createElement(LucideIcon, props) : null;
        };
        
        const App = () => {
            const { theme, toggleTheme } = useAppStore();
            React.useEffect(() => {
                 const currentTheme = useAppStore.getState().theme;
                 if (currentTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                 } else {
                    document.documentElement.classList.remove('dark');
                 }
            }, []);
            return React.createElement('div', { className: 'flex flex-col lg:flex-row min-h-screen lg:h-screen w-full bg-base-light dark:bg-base font-sans lg:overflow-hidden' },
                React.createElement(Toaster, { richColors: true, theme: theme, position: "bottom-right" }),
                React.createElement(Sidebar),
                React.createElement('div', { className: 'flex-1 flex flex-col min-w-0' }, // Added min-w-0 for flexbox shrink
                    React.createElement(Header, { toggleTheme: toggleTheme, theme: theme }),
                    React.createElement(MainContent)
                )
            );
        };

        const MainContent = () => {
            const { activeAgentId, activeTab, setActiveTab } = useAppStore();
            const getActiveAgentData = () => {
                const state = useAppStore.getState();
                for (const ma of state.multiAgents) {
                    if (ma.id === state.activeAgentId) return ma;
                    const subAgent = ma.subAgents.find(sa => sa.id === state.activeAgentId);
                    if (subAgent) return subAgent;
                }
                return state.multiAgents[0] || null;
            }
            const activeAgent = getActiveAgentData();
            const activeMultiAgent = activeAgent?.type === 'multi_agent' 
                ? activeAgent 
                : useAppStore.getState().multiAgents.find(ma => ma.subAgents.some(sa => sa.id === activeAgentId));

            return React.createElement('main', { className: 'flex flex-col lg:flex-row flex-1 p-2 sm:p-4 gap-4 overflow-y-auto lg:overflow-hidden' },
                React.createElement('div', {className: 'w-full lg:w-[300px] lg:flex-shrink-0 flex flex-col gap-4'},
                    React.createElement(AgentPanel),
                    React.createElement('div', {className: 'hidden lg:block'}, React.createElement(ChecklistPanel, { agent: activeAgent, multiAgent: activeMultiAgent }))
                ),
                React.createElement('div', { className: 'flex-1 flex flex-col bg-card-light dark:bg-card rounded-2xl min-h-0' },
                    React.createElement(TabSwitcher, { activeTab, setActiveTab }),
                    React.createElement('div', { className: 'flex-1 overflow-y-auto' },
                       activeTab === 'config' 
                           ? React.createElement('div', {className:'p-4 sm:p-6'}, 
                                React.createElement(ConfigPanel, { key: activeAgentId, agent: activeAgent, multiAgent: activeMultiAgent }),
                                React.createElement('div', {className:'block lg:hidden mt-4'}, React.createElement(ChecklistPanel, { agent: activeAgent, multiAgent: activeMultiAgent }))
                            )
                           : React.createElement(PreviewPanel, { multiAgent: activeMultiAgent })
                    ),
                    activeTab === 'config' && React.createElement(Footer)
                )
            );
        };

        const TabSwitcher = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'config', label: 'Configuração', icon: 'config' },
                { id: 'preview', label: 'Prévia', icon: 'eye' }
            ];
            return React.createElement('div', { className: 'flex items-center p-2 border-b border-border-light dark:border-border' },
                tabs.map(tab => React.createElement('button', {
                    key: tab.id, onClick: () => setActiveTab(tab.id),
                    className: `flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg transition-colors ${activeTab === tab.id ? 'bg-primary/10 dark:bg-primary/20 text-primary' : 'text-secondary-text-light dark:text-secondary-text hover:bg-base-light dark:hover:bg-base'}`
                }, React.createElement(Icon, { name: tab.icon, className: 'h-4 w-4' }), React.createElement('span', {className:'hidden sm:inline'}, tab.label)))
            );
        };

        const Sidebar = () => {
            const { isSidebarOpen, toggleSidebar } = useAppStore();
            const items = [
                { icon: 'message', label: 'Caixa de Entrada' }, { icon: 'botMessage', label: 'Conversas' },
                { icon: 'users', label: 'Contatos' }, { icon: 'chart', label: 'Relatórios' },
                { icon: 'megaphone', label: 'Campanhas' }, { icon: 'help', label: 'Central de Ajuda' },
                { icon: 'settings', label: 'Configurações' }
            ];
            return React.createElement(React.Fragment, null,
                React.createElement('aside', { className: `fixed lg:relative inset-y-0 left-0 z-30 w-64 flex-shrink-0 bg-card-light dark:bg-card border-r border-border-light dark:border-border flex-col transform transition-transform duration-300 ease-in-out ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0 lg:flex` },
                    React.createElement('div', { className: 'h-16 flex items-center px-6 border-b border-border-light dark:border-border' },
                        React.createElement(Icon, { name: 'bot', className: 'h-8 w-8 text-primary' }),
                        React.createElement('h1', { className: 'ml-3 text-xl font-bold text-primary-text-light dark:text-primary-text' }, "Builder Pro")
                    ),
                    React.createElement('nav', { className: 'flex-1 p-4' },
                        items.map(item => React.createElement('a', {
                            key: item.label, href: '#', onClick: () => toast.info(`${item.label} - Não implementado.`),
                            className: 'flex items-center px-4 py-2.5 text-secondary-text-light dark:text-secondary-text rounded-lg hover:bg-base-light dark:hover:bg-base hover:text-primary-text-light dark:hover:text-primary-text transition-colors'
                        }, React.createElement(Icon, { name: item.icon, className: 'h-5 w-5 mr-4' }), item.label))
                    )
                ),
                isSidebarOpen && React.createElement('div', { onClick: toggleSidebar, className: 'fixed inset-0 bg-black/50 z-20 lg:hidden' })
            );
        };
        
        const Header = ({ toggleTheme, theme }) => {
            const { toggleSidebar } = useAppStore();
            return React.createElement('header', { className: 'h-16 flex-shrink-0 bg-card-light dark:bg-card border-b border-border-light dark:border-border flex items-center justify-between px-6' },
                React.createElement('div', { className: 'flex items-center gap-2 sm:gap-4' },
                    React.createElement('button', { onClick: toggleSidebar, className: 'lg:hidden p-2 -ml-2 rounded-full text-secondary-text-light dark:text-secondary-text hover:bg-base-light dark:hover:bg-base' }, React.createElement(Icon, { name: 'menu', className: 'h-5 w-5' })),
                    React.createElement('h2', { className: 'text-lg sm:text-2xl font-bold text-primary-text-light dark:text-primary-text' }, "ChatBot Builder"),
                    React.createElement('span', { className: 'hidden sm:block px-3 py-1 text-xs font-semibold text-green-800 dark:text-green-200 bg-green-500/10 dark:bg-green-500/20 rounded-full border border-green-500/20 dark:border-green-500/30' }, "IA Avançada")
                ),
                React.createElement('div', { className: 'flex items-center gap-2 sm:gap-4' },
                   React.createElement('button', { onClick: () => toast.info('Não implementado.'), className: 'p-2 rounded-full text-secondary-text-light dark:text-secondary-text hover:bg-base-light dark:hover:bg-base' }, React.createElement(Icon, { name: 'help', className: 'h-5 w-5' })),
                   React.createElement('button', { onClick: toggleTheme, className: 'p-2 rounded-full text-secondary-text-light dark:text-secondary-text hover:bg-base-light dark:hover:bg-base' }, React.createElement(Icon, { name: theme === 'dark' ? 'sun' : 'moon', className: 'h-5 w-5' }))
                )
            );
        };

        const getChecklistStatus = (agent, multiAgent) => {
            if (!agent) return { items: [], isComplete: false };
            const isMulti = agent.type === 'multi_agent';
            const targetAgent = isMulti ? agent : multiAgent;
            const checklistItems = [
                { label: "Prompt Definido", completed: agent.prompt && agent.prompt.length > 10 },
                { label: "Base de Conhecimento", completed: isMulti && targetAgent.knowledgeBase.length > 0, multiOnly: true },
                { label: "Ferramentas Ativadas", completed: isMulti && targetAgent.tools.some(t => t.enabled), multiOnly: true },
                { label: "Regras de Saída Criadas", completed: isMulti && targetAgent.outputs.length > 0, multiOnly: true },
                { label: "Palavras-chave", completed: isMulti && (targetAgent.keywords.ignore || targetAgent.keywords.list.length > 0), multiOnly: true },
                { label: "Canais Conectados", completed: isMulti && targetAgent.channels.length > 0, multiOnly: true },
                { label: "Sub-agentes Adicionados", completed: isMulti && targetAgent.subAgents.length > 0, multiOnly: true },
            ];
            const relevantItems = isMulti ? checklistItems : checklistItems.filter(item => !item.multiOnly);
            const isComplete = relevantItems.every(item => item.completed);
            return { items: relevantItems, isComplete };
        };

        const AgentPanel = () => {
            const { multiAgents, addMultiAgent } = useAppStore();
            return React.createElement('div', { className: 'bg-card-light dark:bg-card rounded-2xl flex flex-col p-4 overflow-y-auto flex-grow' },
                React.createElement('h3', { className: 'text-lg font-semibold mb-4 px-2 text-primary-text-light dark:text-primary-text' }, 'Agentes'),
                multiAgents.map(ma => React.createElement(MultiAgentNode, { key: ma.id, multiAgent: ma })),
                React.createElement('button', { onClick: addMultiAgent, className: 'mt-4 w-full flex items-center justify-center gap-2 py-2 px-4 rounded-lg bg-primary/10 text-primary hover:bg-primary/20' }, 
                    React.createElement(Icon, { name: 'plus', className: 'h-4 w-4'}), 'Novo Multi-Agente')
            );
        };

        const MultiAgentNode = ({ multiAgent }) => {
            const { activeAgentId, setActiveAgentId, addSubAgent, renameAgent, deleteAgent, duplicateAgent } = useAppStore();
            const [isRenaming, setIsRenaming] = React.useState(false);
            const [newName, setNewName] = React.useState(multiAgent.name);
            const handleRename = () => { if (newName.trim()) { renameAgent(multiAgent.id, newName.trim()); setIsRenaming(false); } };
            
            const { isComplete } = getChecklistStatus(multiAgent, multiAgent);

            return React.createElement('div', { className: 'mb-4' },
                React.createElement('div', { onClick: () => setActiveAgentId(multiAgent.id), className: `flex items-center justify-between p-2 rounded-lg cursor-pointer ${activeAgentId === multiAgent.id ? 'bg-primary/10 dark:bg-primary/20 agent-selected' : 'hover:bg-base-light dark:hover:bg-base'}`}, 
                   React.createElement('div', {className: 'flex items-center gap-2'},
                      !isComplete && React.createElement(Icon, { name: 'alert', className: 'h-4 w-4 text-warning' }),
                      isRenaming 
                       ? React.createElement('input', { type: 'text', value: newName, onChange: e => setNewName(e.target.value), onBlur: handleRename, onKeyDown: e => e.key === 'Enter' && handleRename(), className: 'bg-input-bg-light dark:bg-input-bg w-full text-sm font-semibold rounded px-1' })
                       : React.createElement('span', { className: 'font-semibold text-primary-text-light dark:text-primary-text' }, multiAgent.name)
                   ),
                    React.createElement(AgentContextMenu, { agentId: multiAgent.id, onRename: () => setIsRenaming(true), onDelete: () => deleteAgent(multiAgent.id), onDuplicate: () => duplicateAgent(multiAgent.id) })
                ),
                React.createElement('div', { className: 'pl-4 mt-2 border-l-2 border-border-light/50 dark:border-border/50 space-y-2' },
                    multiAgent.subAgents.map(sa => React.createElement(SubAgentNode, { key: sa.id, subAgent: sa, multiAgent: multiAgent })),
                     React.createElement('button', { onClick: () => addSubAgent(multiAgent.id), className: 'w-full flex items-center gap-2 text-sm py-1 px-2 text-secondary-text-light dark:text-secondary-text hover:text-primary-text-light dark:hover:text-primary-text' }, 
                        React.createElement(Icon, { name: 'plus', className: 'h-4 w-4'}), 'Adicionar Agente')
                )
            );
        };

        const SubAgentNode = ({ subAgent, multiAgent }) => {
            const { activeAgentId, setActiveAgentId, renameAgent, deleteAgent, duplicateAgent } = useAppStore();
            const [isRenaming, setIsRenaming] = React.useState(false);
            const [newName, setNewName] = React.useState(subAgent.name);
            const handleRename = () => { if (newName.trim()) { renameAgent(subAgent.id, newName.trim()); setIsRenaming(false); } };
            
            const { isComplete } = getChecklistStatus(subAgent, multiAgent);

            return React.createElement('div', { onClick: () => setActiveAgentId(subAgent.id), className: `flex items-center justify-between p-2 rounded-lg cursor-pointer ${activeAgentId === subAgent.id ? 'bg-primary/10 dark:bg-primary/20 agent-selected' : 'hover:bg-base-light dark:hover:bg-base'}`},
                 React.createElement('div', {className: 'flex items-center gap-2'},
                      !isComplete && React.createElement(Icon, { name: 'alert', className: 'h-4 w-4 text-warning' }),
                      isRenaming 
                       ? React.createElement('input', { type: 'text', value: newName, onChange: e => setNewName(e.target.value), onBlur: handleRename, onKeyDown: e => e.key === 'Enter' && handleRename(), className: 'bg-input-bg-light dark:bg-input-bg w-full text-sm rounded px-1' })
                       : React.createElement('span', { className: 'text-sm text-secondary-text-light dark:text-secondary-text' }, subAgent.name)
                 ),
                 React.createElement(AgentContextMenu, { agentId: subAgent.id, onRename: () => setIsRenaming(true), onDelete: () => deleteAgent(subAgent.id), onDuplicate: () => duplicateAgent(subAgent.id) })
            );
        };

        const AgentContextMenu = ({ agentId, onRename, onDelete, onDuplicate }) => {
            const [isOpen, setIsOpen] = React.useState(false);
            const menuRef = React.useRef(null);
            React.useEffect(() => {
                const handleClickOutside = (event) => { if (menuRef.current && !menuRef.current.contains(event.target)) setIsOpen(false); };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [menuRef]);
            const actions = [
                { label: 'Renomear', icon: 'edit', action: onRename },
                { label: 'Duplicar', icon: 'copyIcon', action: onDuplicate },
                { label: 'Excluir', icon: 'trash', action: onDelete, className: 'text-danger' }
            ];
            return React.createElement('div', { className: 'relative', ref: menuRef },
                React.createElement('button', { onClick: (e) => { e.stopPropagation(); setIsOpen(!isOpen); }, className: 'p-1 rounded hover:bg-input-bg-light dark:hover:bg-input-bg' }, React.createElement(Icon, { name: 'more', className: 'h-4 w-4'})),
                isOpen && React.createElement('div', { className: 'absolute z-10 right-0 mt-2 w-40 bg-card-light dark:bg-card border border-border-light dark:border-border rounded-lg shadow-2xl fade-in' },
                    React.createElement('ul', { className: 'p-1' }, actions.map(action => React.createElement('li', { key: action.label },
                        React.createElement('button', { onClick: (e) => { e.stopPropagation(); action.action(); setIsOpen(false); }, className: `w-full flex items-center gap-2 px-3 py-1.5 text-sm rounded-md hover:bg-base-light dark:hover:bg-base ${action.className || ''}` },
                            React.createElement(Icon, { name: action.icon, className: 'h-4 w-4'}), action.label))))
                )
            );
        };
        
        const ChecklistPanel = ({ agent, multiAgent }) => {
            if(!agent) return null;
            const { items } = getChecklistStatus(agent, multiAgent);
            return React.createElement('div', { className: 'bg-card-light dark:bg-card rounded-2xl p-4' },
                 React.createElement('h4', { className: 'font-semibold text-md mb-3 text-primary-text-light dark:text-primary-text' }, 'Checklist de Configuração'),
                 React.createElement('ul', { className: 'space-y-2' },
                    items.map(item => React.createElement('li', { key: item.label, className: 'flex items-center text-sm' },
                        React.createElement(Icon, { 
                            name: item.completed ? 'checkCircle' : 'circle', 
                            className: `h-4 w-4 mr-2 ${item.completed ? 'text-accent' : 'text-secondary-text-light dark:text-secondary-text'}`
                        }),
                        React.createElement('span', { className: item.completed ? 'text-primary-text-light dark:text-primary-text' : 'text-secondary-text-light dark:text-secondary-text' }, item.label)
                    ))
                 )
            );
        };

        const ConfigSection = ({ title, description, children }) => (
            React.createElement('div', { className: 'mb-8 fade-in' },
                React.createElement('h3', { className: 'text-lg font-semibold text-primary-text-light dark:text-primary-text' }, title),
                React.createElement('p', { className: 'text-sm text-secondary-text-light dark:text-secondary-text mb-4' }, description),
                children
            )
        );

        const ConfigPanel = ({ agent, multiAgent }) => {
            if (!agent) return React.createElement('div', { className: 'flex items-center justify-center h-full' }, React.createElement('p', { className: 'text-secondary-text-light dark:text-secondary-text' }, 'Selecione um agente para configurar.'));
            const { updateAgentConfig } = useAppStore();

            return React.createElement('div', { className: 'w-full' },
                React.createElement('h2', { className: 'text-2xl font-bold mb-1 text-primary-text-light dark:text-primary-text' }, agent.name),
                React.createElement('p', { className: 'text-sm text-secondary-text-light dark:text-secondary-text mb-2' }, `ID: ${agent.id}`),
                 React.createElement('div', { className: 'mb-6' },
                    React.createElement('label', { className: 'text-sm font-medium text-secondary-text-light dark:text-secondary-text' }, 'Especialidade'),
                    React.createElement('input', {
                        type: 'text',
                        value: agent.specialty || '',
                        onChange: e => updateAgentConfig(agent.id, 'specialty', e.target.value),
                        placeholder: 'Ex: Especialista em imóveis de luxo',
                        className: 'mt-1 w-full p-2 bg-input-bg-light dark:bg-input-bg border border-border-light dark:border-border rounded-lg text-sm'
                    })
                ),
                React.createElement(PromptCard, { agent: agent }),
                agent.type === 'multi_agent' && React.createElement(React.Fragment, null, 
                    React.createElement(KnowledgeBaseCard, { multiAgent: agent }),
                    React.createElement(ToolsCard, { multiAgent: agent }),
                    React.createElement(OutputsCard, { multiAgent: agent }),
                    React.createElement(KeywordsCard, { multiAgent: agent }),
                    React.createElement(ChannelsCard, { multiAgent: agent }),
                )
            );
        };
        
        const PromptCard = ({ agent }) => {
            const { updateAgentConfig } = useAppStore();
            const handleApply = () => toast.success(`Estrutura aplicada ao agente "${agent.name}"!`);
            return React.createElement(ConfigSection, { title: 'Prompt do Sistema', description: 'Defina a personalidade e comportamento do agente.' },
                React.createElement('textarea', {
                    value: agent.prompt || '', onChange: e => updateAgentConfig(agent.id, 'prompt', e.target.value),
                    placeholder: 'Ex: Você é um assistente de vendas de imóveis...',
                    className: 'w-full h-40 bg-input-bg-light dark:bg-input-bg border border-border-light dark:border-border rounded-lg p-3 text-sm focus:ring-2 focus:ring-primary'
                }),
                React.createElement('div', { className: 'flex justify-between items-center mt-2' },
                    React.createElement('span', { className: 'text-xs text-secondary-text-light dark:text-secondary-text' }, `${agent.prompt?.length || 0} / 5000`),
                    React.createElement('button', { onClick: handleApply, className: 'px-4 py-2 bg-primary text-white rounded-lg text-sm font-semibold hover:bg-primary-hover' }, 'Aplicar Estrutura no Agente')
                )
            );
        };
        
        const KnowledgeBaseCard = ({ multiAgent }) => {
            const { updateMultiAgentConfig } = useAppStore();
            const [activeTab, setActiveTab] = React.useState('files');
            const [openItemId, setOpenItemId] = React.useState(null);

            const handleAddItem = (type, data) => {
                 const newItem = { id: `kb_${Date.now()}`, type, assignedAgents: [], ...data };
                 const newKb = [...multiAgent.knowledgeBase, newItem];
                 updateMultiAgentConfig(multiAgent.id, 'knowledgeBase', newKb);
                 toast.success('Item adicionado à base de conhecimento!');
            };

            const handleDeleteItem = (itemId) => {
                const newKb = multiAgent.knowledgeBase.filter(item => item.id !== itemId);
                updateMultiAgentConfig(multiAgent.id, 'knowledgeBase', newKb);
                toast.error('Item removido.');
            };

            const handleAssignAgents = (itemId, assignedAgents) => {
                const newKb = multiAgent.knowledgeBase.map(item => item.id === itemId ? { ...item, assignedAgents } : item);
                updateMultiAgentConfig(multiAgent.id, 'knowledgeBase', newKb);
            };

            const tabs = [
                { id: 'files', label: 'Arquivos', icon: 'upload' },
                { id: 'text', label: 'Texto', icon: 'file' },
                { id: 'faq', label: 'FAQ', icon: 'faq' },
                { id: 'url', label: 'URL', icon: 'link' },
                { id: 'produtos', label: 'Produtos', icon: 'package' }
            ];

            const renderContent = () => {
                const filteredItems = multiAgent.knowledgeBase.filter(item => item.type === activeTab);
                return React.createElement('div', {className: 'mt-4'},
                    React.createElement(KnowledgeInput, { type: activeTab, onAdd: handleAddItem }),
                    React.createElement('div', {className: 'mt-4 space-y-2'},
                       filteredItems.length === 0 
                           ? React.createElement('p', {className: 'text-center text-sm text-secondary-text-light dark:text-secondary-text py-4'}, 'Nenhum item adicionado.')
                           : filteredItems.map(item => React.createElement(KnowledgeItem, { 
                               key: item.id, item, multiAgent, 
                               isOpen: openItemId === item.id,
                               onToggle: () => setOpenItemId(openItemId === item.id ? null : item.id),
                               onDelete: handleDeleteItem,
                               onAssign: handleAssignAgents
                           }))
                    )
                );
            };

            return React.createElement(ConfigSection, { title: "Base de Conhecimento", description: "Alimente seu agente com informações, arquivos e FAQs."}, 
                React.createElement('div', {className: 'flex items-center gap-2 border-b border-border-light dark:border-border overflow-x-auto'},
                    tabs.map(tab => React.createElement('button', {
                        key: tab.id, onClick: () => setActiveTab(tab.id),
                        className: `flex items-center gap-2 px-3 py-2 text-sm font-medium border-b-2 shrink-0 ${activeTab === tab.id ? 'border-primary text-primary' : 'border-transparent text-secondary-text-light dark:text-secondary-text hover:text-primary-text-light dark:hover:text-primary-text'}`
                    }, React.createElement(Icon, { name: tab.icon, className: 'h-4 w-4'}), tab.label))
                ),
                renderContent()
            );
        };

        const KnowledgeInput = ({ type, onAdd }) => {
            const [textTitle, setTextTitle] = React.useState('');
            const [textContent, setTextContent] = React.useState('');
            const [faqQ, setFaqQ] = React.useState('');
            const [faqA, setFaqA] = React.useState('');
            const [url, setUrl] = React.useState('');
            const [isCrawling, setIsCrawling] = React.useState(false);
            const [productTitle, setProductTitle] = React.useState('');
            const [productDesc, setProductDesc] = React.useState('');
            const fileInputRef = React.useRef(null);
            const productFileRef = React.useRef(null);


            const handleAddText = () => {
                if(textTitle.trim() && textContent.trim()) {
                    onAdd('text', { title: textTitle, content: textContent });
                    setTextTitle(''); setTextContent('');
                }
            };
            const handleAddFaq = () => {
                if(faqQ.trim() && faqA.trim()) {
                    onAdd('faq', { question: faqQ, answer: faqA });
                    setFaqQ(''); setFaqA('');
                }
            };
            
            const readFileContent = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    if (file.type.startsWith('text/')) {
                        reader.onload = (event) => resolve(event.target.result);
                        reader.onerror = (err) => reject(err);
                        reader.readAsText(file);
                    } else if (file.type === 'application/pdf') {
                        reader.onload = async (event) => {
                            try {
                                const pdf = await pdfjsLib.getDocument(event.target.result).promise;
                                let fullText = '';
                                for (let i = 1; i <= pdf.numPages; i++) {
                                    const page = await pdf.getPage(i);
                                    const textContent = await page.getTextContent();
                                    fullText += textContent.items.map(item => item.str).join(' ');
                                }
                                resolve(fullText);
                            } catch (pdfError) {
                                reject(pdfError);
                            }
                        };
                        reader.onerror = (err) => reject(err);
                        reader.readAsArrayBuffer(file);
                    } else if (file.type.startsWith('image/')) {
                        reader.onload = (event) => resolve(event.target.result); // base64 string
                        reader.onerror = (err) => reject(err);
                        reader.readAsDataURL(file);
                    } else {
                        reject(new Error("Tipo de arquivo não suportado"));
                    }
                });
            };

            const handleAddProduct = async () => {
                const file = productFileRef.current.files[0];
                if (!productTitle.trim() || !file) {
                    toast.error('Título e arquivo do produto são obrigatórios.');
                    return;
                }
                
                const fileToast = toast.loading(`Lendo arquivo do produto...`);
                try {
                    const content = await readFileContent(file);
                    onAdd('produtos', { 
                        title: productTitle, 
                        description: productDesc, 
                        fileName: file.name, 
                        content: content,
                        fileType: file.type
                    });
                    setProductTitle('');
                    setProductDesc('');
                    productFileRef.current.value = null;
                    toast.success('Produto adicionado!', { id: fileToast });
                } catch (error) {
                    toast.error(`Erro: ${error.message}`, { id: fileToast });
                }
            };

            const handleCrawlUrl = async () => {
                if (!url.trim() || !url.startsWith('http')) {
                    toast.error('Por favor, insira uma URL válida.');
                    return;
                }
                setIsCrawling(true);
                const crawlToast = toast.loading('Rastreando URL...');
                try {
                    // This is a placeholder for a proper scraping API. Direct fetch will be blocked by CORS.
                    // A real implementation would require a backend service.
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    const fakeContent = `Conteúdo extraído da URL: ${url}. Em uma aplicação real, aqui estaria o texto da página.`;
                    onAdd('url', { url: url, content: fakeContent });
                    setUrl('');
                    toast.success('URL rastreada e adicionada!', { id: crawlToast });
                } catch (error) {
                    console.error("Crawl error:", error);
                    toast.error(`Erro ao rastrear: ${error.message}`, { id: crawlToast });
                } finally {
                    setIsCrawling(false);
                }
            };
            
            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if(!file) return;

                const fileToast = toast.loading(`Lendo ${file.name}...`);
                try {
                   const content = await readFileContent(file);
                   onAdd('files', { name: file.name, content: content });
                   toast.success(`${file.name} lido com sucesso!`, { id: fileToast });
                } catch (error) {
                    toast.error(`Erro ao processar o arquivo: ${error.message}`, { id: fileToast });
                } finally {
                    e.target.value = null; // Reset input
                }
            };

            const commonInputClass = 'w-full p-2 bg-input-bg-light dark:bg-input-bg border border-border-light dark:border-border rounded-md';

            switch(type) {
                case 'files': return React.createElement('div', null, 
                    React.createElement('input', { type: 'file', ref: fileInputRef, onChange: handleFileChange, className:'hidden', accept: '.txt,.pdf,.md' }),
                    React.createElement('button', {onClick: () => fileInputRef.current.click(), className: 'w-full flex flex-col items-center justify-center p-4 border-2 border-dashed border-border-light dark:border-border rounded-lg hover:bg-input-bg-light dark:hover:bg-input-bg'}, 
                        React.createElement(Icon, {name:'upload', className: 'h-6 w-6 text-secondary-text-light dark:text-secondary-text mb-2'}), 
                        React.createElement('span', {className:'text-sm'}, 'Arraste ou clique para enviar'),
                        React.createElement('span', {className:'text-xs text-secondary-text-light dark:text-secondary-text mt-1'}, 'TXT, PDF, MD')
                    )
                );
                case 'text': return React.createElement('div', {className: 'space-y-2'},
                    React.createElement('input', { type: 'text', placeholder: 'Título', value: textTitle, onChange: e => setTextTitle(e.target.value), className: commonInputClass }),
                    React.createElement('textarea', { placeholder: 'Conteúdo...', value: textContent, onChange: e => setTextContent(e.target.value), className: `w-full h-24 ${commonInputClass}` }),
                    React.createElement('button', { onClick: handleAddText, className: 'px-4 py-2 bg-primary text-white rounded-lg text-sm font-semibold' }, 'Adicionar Texto')
                );
                 case 'faq': return React.createElement('div', {className: 'space-y-2'},
                    React.createElement('input', { type: 'text', placeholder: 'Pergunta', value: faqQ, onChange: e => setFaqQ(e.target.value), className: commonInputClass }),
                    React.createElement('textarea', { placeholder: 'Resposta...', value: faqA, onChange: e => setFaqA(e.target.value), className: `w-full h-20 ${commonInputClass}` }),
                    React.createElement('button', { onClick: handleAddFaq, className: 'px-4 py-2 bg-primary text-white rounded-lg text-sm font-semibold' }, 'Adicionar FAQ')
                );
                case 'url': return React.createElement('div', { className: 'flex gap-2' },
                    React.createElement('input', { type: 'url', placeholder: 'https://', value: url, onChange: e => setUrl(e.target.value), className: 'flex-1 p-2 bg-input-bg-light dark:bg-input-bg border border-border-light dark:border-border rounded-md' }),
                    React.createElement('button', { onClick: handleCrawlUrl, disabled: isCrawling, className: 'px-4 py-2 bg-primary text-white rounded-lg text-sm font-semibold flex items-center gap-2 disabled:opacity-50' }, 
                       isCrawling && React.createElement(Icon, { name: 'loader', className: 'h-4 w-4 animate-spin' }),
                       isCrawling ? 'Rastreando...' : 'Rastrear'
                    )
                );
                case 'produtos': return React.createElement('div', {className: 'space-y-2'},
                    React.createElement('input', { type: 'text', placeholder: 'Título do Produto', value: productTitle, onChange: e => setProductTitle(e.target.value), className: commonInputClass }),
                    React.createElement('textarea', { placeholder: 'Descrição do Produto...', value: productDesc, onChange: e => setProductDesc(e.target.value), className: `w-full h-24 ${commonInputClass}` }),
                    React.createElement('input', { type: 'file', ref: productFileRef, className: commonInputClass, accept: '.txt,.pdf,.md,.png,.jpg,.jpeg' }),
                    React.createElement('button', { onClick: handleAddProduct, className: 'px-4 py-2 bg-primary text-white rounded-lg text-sm font-semibold' }, 'Adicionar Produto')
                );
                default: return null;
            }
        };

        const KnowledgeItem = ({ item, multiAgent, isOpen, onToggle, onDelete, onAssign }) => {
            const [assigned, setAssigned] = React.useState(item.assignedAgents || []);

            const handleToggleAgent = (agentId) => {
                const newAssigned = assigned.includes(agentId) ? assigned.filter(id => id !== agentId) : [...assigned, agentId];
                setAssigned(newAssigned);
                onAssign(item.id, newAssigned);
            };
            
            const getTitle = () => {
                switch(item.type) {
                    case 'text': return item.title;
                    case 'faq': return item.question;
                    case 'url': return item.url;
                    case 'files': return item.name;
                    case 'produtos': return item.title;
                    default: return item.id;
                }
            };

            return React.createElement('div', {className: 'bg-input-bg-light dark:bg-input-bg border border-border-light dark:border-border rounded-lg'},
                React.createElement('div', {className: 'flex items-center justify-between p-3 cursor-pointer', onClick: onToggle}, 
                    React.createElement('p', {className: 'text-sm font-medium truncate'}, getTitle()),
                    React.createElement('div', {className: 'flex items-center gap-2'},
                        React.createElement('span', {className:'text-xs text-secondary-text-light dark:text-secondary-text'}, `${assigned.length} agente(s)`),
                        React.createElement('button', { onClick: (e) => { e.stopPropagation(); onDelete(item.id); }, className:'p-1 hover:text-danger'}, React.createElement(Icon, {name:'trash', className: 'h-4 w-4'})),
                        React.createElement(Icon, {name: 'down', className: `h-4 w-4 transition-transform ${isOpen ? 'rotate-180' : ''}`})
                    )
                ),
                isOpen && React.createElement('div', {className: 'p-3 border-t border-border-light dark:border-border'},
                    multiAgent.subAgents.length > 0 
                    ? multiAgent.subAgents.map(agent => React.createElement('label', { key: agent.id, className: 'flex items-center gap-2 p-1.5 rounded-md hover:bg-base-light dark:hover:bg-base text-sm' },
                        React.createElement('input', {type: 'checkbox', checked: assigned.includes(agent.id), onChange: () => handleToggleAgent(agent.id), className: 'w-4 h-4 rounded bg-base-light dark:bg-base border-border-light dark:border-border text-primary focus:ring-primary'}),
                        agent.name
                    ))
                    : React.createElement('p', {className:'text-xs text-center text-secondary-text-light dark:text-secondary-text'}, 'Crie sub-agentes para atribuir.')
                )
            );
        };
        
        const ToolsCard = ({ multiAgent }) => {
             const { updateMultiAgentConfig } = useAppStore();
             const [configuringTool, setConfiguringTool] = React.useState(null);
             const [assigningTool, setAssigningTool] = React.useState(null);
             
             const handleToggleTool = (toolId, enabled) => {
                const newTools = multiAgent.tools.map(t => t.id === toolId ? { ...t, enabled } : t);
                updateMultiAgentConfig(multiAgent.id, 'tools', newTools);
             };

             const handleAssignAgents = (toolId, assignedAgents) => {
                 const newTools = multiAgent.tools.map(t => t.id === toolId ? { ...t, assignedAgents } : t);
                 updateMultiAgentConfig(multiAgent.id, 'tools', newTools);
                 toast.success('Agentes atribuídos à ferramenta!');
             };

             const handleConfigSave = (toolId, newConfig) => {
                const newTools = multiAgent.tools.map(t => t.id === toolId ? { ...t, config: newConfig } : t);
                updateMultiAgentConfig(multiAgent.id, 'tools', newTools);
                toast.success(`Configurações da ferramenta "${multiAgent.tools.find(t=>t.id===toolId).name}" salvas!`);
             };

            const toolIcons = { 'Busca na Web': 'search', 'Calculadora': 'calculator', 'Envio de Email': 'mail', 'Agendamento': 'calendar', 'Integração API': 'globe' };
            return React.createElement(ConfigSection, { title: "Ferramentas", description: "Capacite seu agente com habilidades extras." },
                configuringTool && React.createElement(ToolConfigModal, { tool: configuringTool, onClose: () => setConfiguringTool(null), onSave: handleConfigSave }),
                assigningTool && React.createElement(AssignToolModal, { tool: assigningTool, multiAgent, onClose: () => setAssigningTool(null), onSave: handleAssignAgents }),
                React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                    multiAgent.tools.map(tool => React.createElement('div', { key: tool.id, className: 'bg-card-light dark:bg-card border border-border-light dark:border-border p-4 rounded-xl flex flex-col gap-4 transition-all hover:shadow-lg hover:-translate-y-1' },
                        React.createElement('div', { className: 'flex justify-between items-start' },
                          React.createElement('div', { className: 'flex items-center gap-4' },
                            React.createElement('div', { className: 'p-3 bg-primary/10 rounded-lg' }, React.createElement(Icon, { name: toolIcons[tool.name], className: 'h-6 w-6 text-primary' })),
                            React.createElement('div', null,
                              React.createElement('h4', { className: 'font-semibold text-primary-text-light dark:text-primary-text' }, tool.name),
                              React.createElement('p', { className: 'text-xs text-secondary-text-light dark:text-secondary-text' }, tool.description)
                            )
                          ),
                          React.createElement('button', { onClick: () => handleToggleTool(tool.id, !tool.enabled), className: `relative inline-flex h-6 w-11 items-center rounded-full ${tool.enabled ? 'bg-primary' : 'bg-input-bg-light dark:bg-input-bg border border-border-light dark:border-border'}` },
                            React.createElement('span', { className: `inline-block h-4 w-4 transform rounded-full bg-white transition ${tool.enabled ? 'translate-x-6' : 'translate-x-1'}` })
                          )
                        ),
                        React.createElement('div', { className: 'flex items-center gap-2 mt-auto' },
                          React.createElement('button', { onClick: () => setConfiguringTool(tool), className: 'flex-1 text-sm py-2 px-3 bg-base-light dark:bg-base border border-border-light dark:border-border rounded-md hover:bg-border-light/50 dark:hover:bg-border/50 font-semibold transition-colors' }, 'Configurar'),
                          React.createElement('button', { onClick: () => setAssigningTool(tool), className: 'flex-1 text-sm py-2 px-3 bg-base-light dark:bg-base border border-border-light dark:border-border rounded-md hover:bg-border-light/50 dark:hover:bg-border/50 font-semibold transition-colors' }, 'Adicionar ao Agente')
                        )
                    ))
                )
            );
        };
        
        const Modal = ({ children, onClose, title }) => (
             React.createElement('div', { className: 'fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4', onClick: onClose },
                React.createElement('div', { className: 'bg-card-light dark:bg-card w-full max-w-lg rounded-2xl border border-border-light dark:border-border shadow-2xl fade-in', onClick: e => e.stopPropagation() },
                    React.createElement('div', {className: 'flex items-center justify-between p-4 border-b border-border-light dark:border-border'},
                        React.createElement('h3', { className: 'text-lg font-bold' }, title),
                        React.createElement('button', {onClick: onClose, className: 'p-1 rounded-full hover:bg-base-light dark:hover:bg-base'}, React.createElement(Icon, {name: 'x', className: 'h-4 w-4'}))
                    ),
                    React.createElement('div', {className: 'p-6 max-h-[70vh] overflow-y-auto'}, children)
                )
            )
        );
        
        const ToolConfigModal = ({ tool, onClose, onSave }) => {
            const [config, setConfig] = React.useState(tool.config || {});
            const updateConfig = (key, value) => setConfig(prev => ({ ...prev, [key]: value }));

            const renderFields = () => {
                const commonInputClass = 'w-full p-2 bg-input-bg-light dark:bg-input-bg border border-border-light dark:border-border rounded-md';
                const commonLabelClass = 'font-semibold block mb-1 text-sm';
                
                const descriptionField = React.createElement('div', { key: 'desc' }, 
                    React.createElement('label', {className: commonLabelClass}, 'Descrição'), 
                    React.createElement('textarea', {
                        placeholder: 'Descreva o propósito desta configuração...',
                        value: config.description || '', 
                        onChange: e => updateConfig('description', e.target.value), 
                        className: commonInputClass
                    })
                );

                let specificFields;
                switch(tool.id) {
                    case 'tool_web_search': specificFields = [
                        React.createElement('div', {key: 'provider'}, React.createElement('label', {className: commonLabelClass}, 'Provedor'), React.createElement('select', {value: config.provider, onChange: e => updateConfig('provider', e.target.value), className: commonInputClass}, React.createElement('option', null, 'Google'), React.createElement('option', null, 'Bing'))),
                        React.createElement('div', {key: 'max'}, React.createElement('label', {className: commonLabelClass}, 'Máx. Resultados'), React.createElement('input', {type: 'number', value: config.maxResults, onChange: e => updateConfig('maxResults', parseInt(e.target.value)), className: commonInputClass})),
                        React.createElement('label', {key: 'safe', className:'flex items-center gap-2 cursor-pointer'}, React.createElement('input', {type: 'checkbox', checked: config.safeSearch, onChange: e => updateConfig('safeSearch', e.target.checked)}), 'SafeSearch')
                    ]; break;
                    case 'tool_calculator': specificFields = [
                        React.createElement('div', {key: 'prec'}, React.createElement('label', {className: commonLabelClass}, 'Precisão Decimal'), React.createElement('input', {type: 'number', min:0, max: 6, value: config.precision, onChange: e => updateConfig('precision', parseInt(e.target.value)), className: commonInputClass})),
                        React.createElement('label', {key: 'complex', className:'flex items-center gap-2 cursor-pointer'}, React.createElement('input', {type: 'checkbox', checked: config.useComplex, onChange: e => updateConfig('useComplex', e.target.checked)}), 'Permitir expressões complexas')
                    ]; break;
                    case 'tool_email': specificFields = [
                        React.createElement('div', {key: 'sender'}, React.createElement('label', {className: commonLabelClass}, 'Remetente'), React.createElement('input', {type: 'email', value: config.sender, onChange: e => updateConfig('sender', e.target.value), className: commonInputClass})),
                        React.createElement('div', {key: 'subj'}, React.createElement('label', {className: commonLabelClass}, 'Assunto Padrão'), React.createElement('input', {type: 'text', value: config.subject, onChange: e => updateConfig('subject', e.target.value), className: commonInputClass}))
                    ]; break;
                    case 'tool_scheduling': specificFields = [
                         React.createElement('div', {key: 'dur'}, React.createElement('label', {className: commonLabelClass}, 'Duração (minutos)'), React.createElement('input', {type: 'number', value: config.duration, onChange: e => updateConfig('duration', parseInt(e.target.value)), className: commonInputClass})),
                         React.createElement('div', {key: 'msg'}, React.createElement('label', {className: commonLabelClass}, 'Mensagem de Confirmação'), React.createElement('textarea', {value: config.confirmationMsg, onChange: e => updateConfig('confirmationMsg', e.target.value), className: commonInputClass}))
                    ]; break;
                    case 'tool_api': specificFields = [
                        React.createElement('div', {key: 'method'}, React.createElement('label', {className: commonLabelClass}, 'Método'), React.createElement('select', {value: config.method, onChange: e => updateConfig('method', e.target.value), className: commonInputClass}, React.createElement('option', null, 'GET'), React.createElement('option', null, 'POST'), React.createElement('option', null, 'PUT'))),
                        React.createElement('div', {key: 'url'}, React.createElement('label', {className: commonLabelClass}, 'URL'), React.createElement('input', {type: 'url', value: config.url, onChange: e => updateConfig('url', e.target.value), className: commonInputClass})),
                        React.createElement('div', {key: 'timeout'}, React.createElement('label', {className: commonLabelClass}, 'Timeout (ms)'), React.createElement('input', {type: 'number', value: config.timeout, onChange: e => updateConfig('timeout', parseInt(e.target.value)), className: commonInputClass}))
                    ]; break;
                    default: specificFields = [React.createElement('p', {key: 'none'}, `Nenhuma configuração disponível.`)];
                }
                return [...specificFields, descriptionField];
            };
            
            return React.createElement(Modal, { title: `Configurar: ${tool.name}`, onClose }, 
                React.createElement('div', {},
                    React.createElement('div', {className: 'space-y-4'}, renderFields()),
                    React.createElement('div', {className: 'flex justify-end gap-3 pt-4 mt-4 border-t border-border-light dark:border-border'},
                        React.createElement('button', { onClick: onClose, className: 'px-4 py-2 rounded-lg bg-base-light dark:bg-base hover:bg-border-light dark:hover:bg-border'}, 'Cancelar'),
                        React.createElement('button', { onClick: () => { onSave(tool.id, config); onClose(); }, className: 'px-4 py-2 rounded-lg bg-primary hover:bg-primary-hover text-white'}, 'Salvar')
                    )
                )
            );
        };
        
        const AssignToolModal = ({ tool, multiAgent, onClose, onSave }) => {
            const [selectedAgents, setSelectedAgents] = React.useState(tool.assignedAgents || []);
            const handleToggle = (agentId) => {
                setSelectedAgents(prev => prev.includes(agentId) ? prev.filter(id => id !== agentId) : [...prev, agentId]);
            };
            const handleSave = () => { onSave(tool.id, selectedAgents); onClose(); };
            return React.createElement(Modal, { title: `Atribuir "${tool.name}"`, onClose}, 
                 multiAgent.subAgents.length === 0 
                    ? React.createElement('p', {className: 'text-center text-secondary-text-light dark:text-secondary-text'}, 'Crie sub-agentes para poder atribuir ferramentas.')
                    : React.createElement('div', { className: 'space-y-3' },
                        multiAgent.subAgents.map(agent => React.createElement('label', { key: agent.id, className: 'flex items-center gap-3 p-2 rounded-md hover:bg-base-light dark:hover:bg-base cursor-pointer' },
                            React.createElement('input', { type: 'checkbox', checked: selectedAgents.includes(agent.id), onChange: () => handleToggle(agent.id), className: 'w-4 h-4 rounded bg-input-bg-light dark:bg-input-bg border-border-light dark:border-border text-primary focus:ring-primary' }),
                            agent.name
                        )),
                        React.createElement('div', {className: 'flex justify-end gap-3 mt-6'},
                            React.createElement('button', { onClick: onClose, className: 'px-4 py-2 rounded-lg bg-base-light dark:bg-base hover:bg-border-light dark:hover:bg-border'}, 'Cancelar'),
                            React.createElement('button', { onClick: handleSave, className: 'px-4 py-2 rounded-lg bg-primary hover:bg-primary-hover text-white'}, 'Salvar')
                        )
                    )
            );
        };

        const OutputsCard = ({ multiAgent }) => {
            const { updateMultiAgentConfig } = useAppStore();
            const [editingRule, setEditingRule] = React.useState(null);
            
            const handleSaveRule = (ruleToSave) => {
                const newOutputs = multiAgent.outputs.some(r => r.id === ruleToSave.id)
                    ? multiAgent.outputs.map(r => r.id === ruleToSave.id ? ruleToSave : r)
                    : [...multiAgent.outputs, ruleToSave];
                updateMultiAgentConfig(multiAgent.id, 'outputs', newOutputs);
                setEditingRule(null);
                toast.success(`Regra "${ruleToSave.name}" salva!`);
            };

            const handleDeleteRule = (ruleId) => {
                const newOutputs = multiAgent.outputs.filter(r => r.id !== ruleId);
                updateMultiAgentConfig(multiAgent.id, 'outputs', newOutputs);
                toast.error("Regra excluída.");
            };

            return React.createElement(ConfigSection, { title: "Base de Saídas", description: "Crie regras de automação para eventos específicos." },
                editingRule !== null && React.createElement(OutputRuleModal, { 
                    rule: editingRule, 
                    agents: multiAgent.subAgents,
                    onClose: () => setEditingRule(null), 
                    onSave: handleSaveRule 
                }),
                React.createElement('div', { className: 'space-y-3' },
                    multiAgent.outputs.map(rule => React.createElement('div', { key: rule.id, className: 'bg-input-bg-light dark:bg-input-bg p-3 rounded-lg border border-border-light dark:border-border flex justify-between items-center' },
                        React.createElement('div', { className: 'flex-1 min-w-0' },
                            React.createElement('p', { className: 'font-semibold truncate' }, rule.name),
                            React.createElement('p', { className: 'text-xs text-secondary-text-light dark:text-secondary-text' }, `${rule.actions.length} Ações`)
                        ),
                        React.createElement('div', {className: 'flex gap-2 shrink-0'},
                           React.createElement('button', { onClick: () => setEditingRule(rule), className: 'p-1 hover:text-primary'}, React.createElement(Icon, {name: 'edit', className: 'h-4 w-4'})),
                           React.createElement('button', { onClick: () => handleDeleteRule(rule.id), className: 'p-1 hover:text-danger'}, React.createElement(Icon, {name: 'trash', className: 'h-4 w-4'}))
                        )
                    )),
                    React.createElement('button', {
                        onClick: () => setEditingRule({ id: `out_${Date.now()}`, name: '', description: '', actions: [] }),
                        className: 'w-full flex items-center justify-center gap-2 py-2 px-4 rounded-lg border-2 border-dashed border-border-light dark:border-border hover:bg-input-bg-light dark:hover:bg-input-bg transition-colors'
                    }, React.createElement(Icon, { name: 'plus' }), 'Adicionar Regra de Saída')
                )
            );
        };
        
        const OutputRuleModal = ({ rule, agents, onClose, onSave }) => {
            const [localRule, setLocalRule] = React.useState(rule);

            const updateField = (key, value) => setLocalRule(prev => ({ ...prev, [key]: value }));
            
            const addAction = () => updateField('actions', [...localRule.actions, { id: `act_${Date.now()}`, type: 'Adicionar Etiqueta', value: ''}]);
            
            const removeAction = (index) => {
                const newActions = localRule.actions.filter((_, i) => i !== index);
                updateField('actions', newActions);
            };
            
            const actionTypeOptions = [
                "Adicionar Etiqueta", "Alterar Etapa do CRM", "Notificar Grupo de WhatsApp", 
                "Adicionar Nota", "Enviar mensagem", "Atribuir Time", "Atribuir Agente", 
                "Escolher Agente com Roleta", "Guardar Valor", "Integração API"
            ];

            const commonInputClass = 'w-full p-2 bg-input-bg-light dark:bg-input-bg border border-border-light dark:border-border rounded-md';

            return React.createElement(Modal, { title: rule.name ? "Editar Regra de Saída" : "Nova Regra de Saída", onClose },
                React.createElement('div', { className: 'space-y-4 text-sm' },
                    React.createElement('div', null,
                        React.createElement('label', { className: 'font-semibold block mb-1' }, 'Nome da Regra'),
                        React.createElement('input', { type: 'text', placeholder: 'Ex: Notificar time de vendas', value: localRule.name, onChange: e => updateField('name', e.target.value), className: commonInputClass })
                    ),
                    React.createElement('div', null,
                        React.createElement('label', { className: 'font-semibold block mb-1' }, 'Descrição'),
                        React.createElement('input', { type: 'text', placeholder: 'Descreva o objetivo desta regra...', value: localRule.description, onChange: e => updateField('description', e.target.value), className: commonInputClass })
                    ),
                    
                    React.createElement('div', null,
                        React.createElement('div', {className: 'flex justify-between items-center mb-2'},
                            React.createElement('label', { className: 'font-semibold' }, 'Ações'),
                            React.createElement('button', {onClick: addAction, className: 'flex items-center gap-1 text-primary text-xs font-semibold'}, React.createElement(Icon, {name:'plus', className: 'h-3 w-3'}), 'Adicionar Ação')
                        ),
                        React.createElement('div', {className: 'space-y-3'}, localRule.actions.map((action, index) => {
                             const handleApiValueChange = (subField, subValue) => {
                                const newActions = JSON.parse(JSON.stringify(localRule.actions));
                                if(typeof newActions[index].value !== 'object') newActions[index].value = {};
                                newActions[index].value[subField] = subValue;
                                setLocalRule(prev => ({ ...prev, actions: newActions }));
                            };

                            return React.createElement('div', { key: action.id, className: 'p-3 bg-base-light dark:bg-base rounded-lg border border-border-light dark:border-border'},
                                React.createElement('div', { className: 'flex gap-2 items-center' },
                                    React.createElement('select', { 
                                        value: action.type, 
                                        onChange: e => {
                                            const newType = e.target.value;
                                            const newValue = newType === 'Integração API' ? { url: '', header: '', body: '', authorization: '' } : '';
                                            
                                            const newActions = [...localRule.actions];
                                            newActions[index] = {...newActions[index], type: newType, value: newValue };
                                            setLocalRule(prev => ({...prev, actions: newActions}));
                                        }, 
                                        className: `flex-1 ${commonInputClass}` 
                                    }, actionTypeOptions.map(opt => React.createElement('option',{key:opt}, opt))),
                                    React.createElement('button', { onClick: () => removeAction(index) }, React.createElement(Icon, { name: 'trash', className: 'h-4 w-4 text-secondary-text-light dark:text-secondary-text hover:text-danger' }))
                                ),
                                action.type === 'Integração API' 
                                    ? React.createElement('div', {className:'mt-3 space-y-2'},
                                        React.createElement('input', { type: 'text', placeholder: "URL", value: action.value.url || '', onChange: e => handleApiValueChange('url', e.target.value), className: commonInputClass }),
                                        React.createElement('textarea', { placeholder: "Header (JSON)", value: action.value.header || '', onChange: e => handleApiValueChange('header', e.target.value), className: `${commonInputClass} h-20` }),
                                        React.createElement('textarea', { placeholder: "Body (JSON)", value: action.value.body || '', onChange: e => handleApiValueChange('body', e.target.value), className: `${commonInputClass} h-20` }),
                                        React.createElement('input', { type: 'text', placeholder: "Authorization", value: action.value.authorization || '', onChange: e => handleApiValueChange('authorization', e.target.value), className: commonInputClass }),
                                    )
                                    : React.createElement('input', { 
                                        type: 'text', 
                                        placeholder: 'Valor da ação', 
                                        value: typeof action.value === 'object' ? '' : action.value, 
                                        onChange: e => {
                                            const newActions = [...localRule.actions];
                                            newActions[index].value = e.target.value;
                                            setLocalRule(prev => ({...prev, actions: newActions}));
                                        }, 
                                        className: `mt-2 ${commonInputClass}` 
                                    })
                            )
                        }))
                    ),

                    React.createElement('div', {className: 'flex justify-end gap-3 pt-4 border-t border-border-light dark:border-border'},
                        React.createElement('button', { onClick: onClose, className: 'px-4 py-2 rounded-lg bg-base-light dark:bg-base hover:bg-border-light dark:hover:bg-border'}, 'Cancelar'),
                        React.createElement('button', { onClick: () => onSave(localRule), className: 'px-4 py-2 rounded-lg bg-primary hover:bg-primary-hover text-white'}, 'Salvar Regra')
                    )
                )
            );
        };

        const KeywordsCard = ({ multiAgent }) => {
            const { updateMultiAgentConfig } = useAppStore();
            const [inputValue, setInputValue] = React.useState('');
            const [editingKeyword, setEditingKeyword] = React.useState(null);
             
            const handleAddKeyword = (e) => {
                if ((e.key === 'Enter' || e.key === ',') && inputValue.trim()) {
                    e.preventDefault();
                    const newKeyword = inputValue.trim().replace(/,$/, '');
                    if (!multiAgent.keywords.list.includes(newKeyword)) {
                        const newList = [...multiAgent.keywords.list, newKeyword];
                        updateMultiAgentConfig(multiAgent.id, 'keywords', {...multiAgent.keywords, list: newList });
                    }
                    setInputValue('');
                }
            };

            const handleRemoveKeyword = (keywordToRemove) => {
                const newList = multiAgent.keywords.list.filter(k => k !== keywordToRemove);
                const newActions = {...multiAgent.keywords.actions};
                delete newActions[keywordToRemove];
                updateMultiAgentConfig(multiAgent.id, 'keywords', {...multiAgent.keywords, list: newList, actions: newActions});
            };

            const handleSaveKeywordAction = (keyword, actions) => {
                 const newActions = {...multiAgent.keywords.actions, [keyword]: actions };
                 updateMultiAgentConfig(multiAgent.id, 'keywords', {...multiAgent.keywords, actions: newActions });
                 setEditingKeyword(null);
                 toast.success(`Ações para "${keyword}" salvas!`);
            };

            const toggleIgnore = () => {
                updateMultiAgentConfig(multiAgent.id, 'keywords', {...multiAgent.keywords, ignore: !multiAgent.keywords.ignore});
            };

            return React.createElement(ConfigSection, { title: "Palavras-chave", description: "Dispare ações baseadas em palavras específicas na conversa." },
                editingKeyword && React.createElement(KeywordActionModal, { 
                    keyword: editingKeyword, 
                    actions: multiAgent.keywords.actions[editingKeyword] || [],
                    onClose: () => setEditingKeyword(null), 
                    onSave: (actions) => handleSaveKeywordAction(editingKeyword, actions)
                }),
                React.createElement('div', { className: 'flex flex-wrap items-center gap-2 p-2 bg-input-bg-light dark:bg-input-bg border border-border-light dark:border-border rounded-lg' },
                    multiAgent.keywords.list.map(kw => React.createElement('span', { 
                        key: kw, 
                        onClick: () => setEditingKeyword(kw),
                        className: 'flex items-center gap-1.5 bg-primary/20 text-primary text-sm font-medium px-2 py-1 rounded cursor-pointer hover:bg-primary/30' 
                    },
                        kw,
                        React.createElement('button', { onClick: (e) => {e.stopPropagation(); handleRemoveKeyword(kw)} }, React.createElement(Icon, { name: 'x', className: 'h-3.5 w-3.5' }))
                    )),
                    React.createElement('input', {
                        value: inputValue,
                        onChange: e => setInputValue(e.target.value),
                        onKeyDown: handleAddKeyword,
                        placeholder: 'Adicionar palavra...',
                        className: 'bg-transparent flex-1 text-sm outline-none p-1 min-w-[100px]'
                    })
                ),
                 React.createElement('label', { className: 'flex items-center gap-2 mt-4 text-sm text-secondary-text-light dark:text-secondary-text cursor-pointer' },
                    React.createElement('input', { 
                        type: 'checkbox',
                        checked: multiAgent.keywords.ignore,
                        onChange: toggleIgnore,
                        className: 'w-4 h-4 rounded bg-base-light dark:bg-base border-border-light dark:border-border text-primary focus:ring-primary'
                    }),
                    'Ignorar palavras-chave'
                )
            );
        };

        const KeywordActionModal = ({ keyword, actions, onClose, onSave }) => {
            const [localActions, setLocalActions] = React.useState(actions);

            const addAction = () => setLocalActions(prev => [...prev, { id: `act_${Date.now()}`, type: 'Enviar Mensagem', value: ''}]);
            const updateAction = (index, key, value) => {
                const newActions = [...localActions];
                newActions[index][key] = value;
                setLocalActions(newActions);
            };
            const removeAction = (index) => setLocalActions(localActions.filter((_, i) => i !== index));
            
            const actionTypeOptions = ["Enviar Mensagem", "Adicionar Etiqueta", "Encerrar Chat", "Enviar Imagem"];
            const commonInputClass = 'w-full p-2 bg-input-bg-light dark:bg-input-bg border border-border-light dark:border-border rounded-md';

            return React.createElement(Modal, { title: `Ações para "${keyword}"`, onClose },
                 React.createElement('div', { className: 'space-y-4 text-sm' },
                     React.createElement('div', {className: 'flex justify-between items-center mb-2'},
                        React.createElement('label', { className: 'font-semibold' }, 'Ações a serem executadas'),
                        React.createElement('button', {onClick: addAction, className: 'flex items-center gap-1 text-primary text-xs font-semibold'}, React.createElement(Icon, {name:'plus', className: 'h-3 w-3'}), 'Adicionar')
                    ),
                    localActions.length === 0 
                        ? React.createElement('p', {className: 'text-xs text-center text-secondary-text-light dark:text-secondary-text py-2'}, 'Nenhuma ação configurada.')
                        : React.createElement('div', {className: 'space-y-2'}, localActions.map((action, index) => React.createElement('div', { key: action.id, className: 'flex gap-2 items-center'},
                            React.createElement('select', { value: action.type, onChange: e => updateAction(index, 'type', e.target.value), className: `flex-1 ${commonInputClass}` }, actionTypeOptions.map(opt => React.createElement('option',{key:opt}, opt))),
                            React.createElement('input', { type: 'text', placeholder: 'Valor da ação (ex: texto ou URL da imagem)', value: action.value, onChange: e => updateAction(index, 'value', e.target.value), className: `flex-1 ${commonInputClass}` }),
                            React.createElement('button', { onClick: () => removeAction(index) }, React.createElement(Icon, { name: 'trash', className: 'h-4 w-4 text-secondary-text-light dark:text-secondary-text hover:text-danger' }))
                        ))),
                    React.createElement('div', {className: 'flex justify-end gap-3 pt-4 border-t border-border-light dark:border-border'},
                        React.createElement('button', { onClick: onClose, className: 'px-4 py-2 rounded-lg bg-base-light dark:bg-base hover:bg-border-light dark:hover:bg-border'}, 'Cancelar'),
                        React.createElement('button', { onClick: () => onSave(localActions), className: 'px-4 py-2 rounded-lg bg-primary hover:bg-primary-hover text-white'}, 'Salvar Ações')
                    )
                )
            );
        };

        const ChannelsCard = ({ multiAgent }) => {
            const { updateMultiAgentConfig } = useAppStore();
            const [showDropdown, setShowDropdown] = React.useState(false);
            const allPossibleChannels = ['WhatsApp', 'Instagram', 'Telegram', 'Messenger', 'Email', 'WebChat'];

            const handleAddChannel = (channel) => {
                 if (!multiAgent.channels.includes(channel)) {
                    updateMultiAgentConfig(multiAgent.id, 'channels', [...multiAgent.channels, channel]);
                }
                setShowDropdown(false);
            };

            const handleRemoveChannel = (channelToRemove) => {
                const newChannels = multiAgent.channels.filter(c => c !== channelToRemove);
                updateMultiAgentConfig(multiAgent.id, 'channels', newChannels);
            };
            
            const availableChannels = allPossibleChannels.filter(c => !multiAgent.channels.includes(c));

            return React.createElement(ConfigSection, { title: "Canais", description: "Defina onde seu chatbot estará ativo." },
                React.createElement('div', { className: 'flex flex-wrap items-center gap-2 p-2 bg-input-bg-light dark:bg-input-bg border border-border-light dark:border-border rounded-lg min-h-[44px]' },
                    multiAgent.channels.map(ch => React.createElement('span', { key: ch, className: 'flex items-center gap-1.5 bg-primary/20 text-primary text-sm font-medium px-2 py-1 rounded' },
                        ch,
                        React.createElement('button', { onClick: () => handleRemoveChannel(ch) }, React.createElement(Icon, { name: 'x', className: 'h-3.5 w-3.5' }))
                    )),
                    React.createElement('div', { className: 'relative' },
                        React.createElement('button', {
                            onClick: () => setShowDropdown(!showDropdown),
                            className: 'bg-base-light dark:bg-base p-1.5 rounded'
                        }, React.createElement(Icon, { name: 'plus', className: 'h-4 w-4 text-secondary-text-light dark:text-secondary-text'})),
                        
                        showDropdown && availableChannels.length > 0 && React.createElement('div', { className: 'absolute z-10 top-full left-0 mt-1 w-40 bg-card-light dark:bg-card border border-border-light dark:border-border rounded-md shadow-lg' },
                            availableChannels.map(c => React.createElement('button', {
                                    key: c,
                                    onClick: () => handleAddChannel(c),
                                    className: 'block w-full text-left px-3 py-1.5 text-sm hover:bg-base-light dark:hover:bg-base'
                                }, c))
                        )
                    )
                )
            );
        };

        const PreviewPanel = ({ multiAgent }) => {
            if (!multiAgent) return React.createElement('div', {className: 'flex items-center justify-center h-full'}, React.createElement('p', {className: 'text-secondary-text-light dark:text-secondary-text'}, 'Selecione um multi-agente para pré-visualizar.'));
            const { getOrCreatePreviewState, addChatMessage, addLogMessage, clearChat } = useAppStore();
            const [input, setInput] = React.useState('');
            const [isTyping, setIsTyping] = React.useState(false);
            const [isLogOpen, setIsLogOpen] = React.useState(false);
            const [isListening, setIsListening] = React.useState(false);
            const imageInputRef = React.useRef(null);

            const { chat: chatHistory, logs } = getOrCreatePreviewState(multiAgent.id);
            const chatEndRef = React.useRef(null);
            
            React.useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [chatHistory]);

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        addChatMessage(multiAgent.id, { from: 'user', text: '', image: reader.result });
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            const handleMicClick = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    toast.error('Reconhecimento de voz não é suportado neste navegador.');
                    return;
                }
                
                const recognition = new SpeechRecognition();
                recognition.lang = 'pt-BR';
                recognition.interimResults = false;

                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onerror = (event) => {
                    toast.error(`Erro no reconhecimento: ${event.error}`);
                    setIsListening(false);
                };
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    setInput(prev => prev ? `${prev} ${transcript}`: transcript);
                };

                recognition.start();
            };

            const handleSend = async () => {
                const lastUserMessage = chatHistory.length > 0 ? chatHistory[chatHistory.length - 1] : null;
                const textToSend = input.trim();
                 // Check if the last message was a user message with an image and no text
                const imageToSend = lastUserMessage?.from === 'user' && lastUserMessage.image && lastUserMessage.text === '' ? lastUserMessage.image : null;
                
                if ((!textToSend && !imageToSend) || isTyping) return;

                // If we are sending only text, create a new message. 
                // If we are sending text for an image just sent, update that message.
                if (imageToSend && textToSend) {
                    // This logic is tricky. For Gemini, we send image and text in the same "turn".
                    // Let's create a new message that has both. We'll remove the old image-only message.
                    const newHistory = chatHistory.slice(0, -1); // remove image-only message
                    const userMessage = { from: 'user', text: textToSend, image: imageToSend };
                    addChatMessage(multiAgent.id, userMessage); // This will re-add it
                    const currentHistory = [...newHistory, userMessage];
                    
                    // The store update is async, so we'll work with `currentHistory`
                    await sendToGemini(currentHistory, userMessage);

                } else {
                    const userMessage = { from: 'user', text: textToSend, image: null };
                    addChatMessage(multiAgent.id, userMessage);
                    const currentHistory = [...chatHistory, userMessage];
                    await sendToGemini(currentHistory, userMessage);
                }
            };
            
            const sendToGemini = async (currentHistory, userMessage) => {
                 setInput('');
                 setIsTyping(true);
                 addLogMessage(multiAgent.id, { title: 'Mensagem do Usuário', data: userMessage });

                 try {
                     const knowledgeBaseText = multiAgent.knowledgeBase
                         .map(item => {
                             if (item.type === 'text') return `Título: ${item.title}\nConteúdo: ${item.content}`;
                             if (item.type === 'faq') return `Pergunta: ${item.question}\nResposta: ${item.answer}`;
                             if (item.type === 'url') return `Fonte (${item.url}):\n${item.content}`;
                             if (item.type === 'files') return `Arquivo (${item.name}):\n${item.content}`;
                             if (item.type === 'produtos') return `Produto: ${item.title}\nDescrição: ${item.description}\nDetalhes: ${item.content}`;
                             return '';
                         })
                         .join('\n\n---\n\n');

                     const fullPrompt = `${multiAgent.prompt || "Responda de forma útil."}\n\nUse a seguinte base de conhecimento para responder:\n${knowledgeBaseText}`;

                     const systemInstruction = { parts: [{ text: fullPrompt }] };

                     const contents = currentHistory.map(msg => {
                         const parts = [];
                         if (msg.text) parts.push({ text: msg.text });
                         if (msg.image) {
                             parts.push({
                                 inlineData: {
                                     mimeType: msg.image.match(/:(.*?);/)[1],
                                     data: msg.image.split(',')[1]
                                 }
                             });
                         }
                         return { role: msg.from === 'user' ? 'user' : 'model', parts };
                     });
                    
                     const payload = { contents, systemInstruction };

                     addLogMessage(multiAgent.id, { title: 'Enviando para API Gemini', data: payload });

                     const apiKey = "AIzaSyA0LecQ2UW0nZvLTlnp-Utp4NHxVeIfvX8";
                     const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                     const response = await fetch(apiUrl, {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(payload)
                     });

                     if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${response.statusText} - ${errorBody?.error?.message}`);
                     }

                     const result = await response.json();
                     addLogMessage(multiAgent.id, { title: 'Resposta Recebida da API', data: result });
                     
                     if (!result.candidates || result.candidates.length === 0 || !result.candidates[0].content) {
                        const finishReason = result.candidates?.[0]?.finishReason;
                        const safetyFeedback = result.promptFeedback?.safetyRatings;
                        let errorMessage = "A IA não retornou uma resposta.";
                        if (finishReason === "SAFETY") {
                           errorMessage = "A resposta foi bloqueada por motivos de segurança.";
                           console.warn("Safety ratings:", safetyFeedback);
                        }
                        throw new Error(errorMessage);
                     }
                     
                     const botResponse = result.candidates[0].content.parts[0].text;
                     addChatMessage(multiAgent.id, { from: 'bot', text: botResponse });

                 } catch (error) {
                     console.error("Gemini API call failed:", error);
                     const errorMsg = "Ocorreu um erro ao conectar com a IA. Tente novamente.";
                     addChatMessage(multiAgent.id, { from: 'bot', text: errorMsg });
                     addLogMessage(multiAgent.id, { title: 'Erro na API', data: { error: error.message }, status: 'error' });
                     toast.error("Erro na API do Gemini.");
                 } finally {
                     setIsTyping(false);
                 }
            }

            return React.createElement('div', { className: 'flex h-full' },
                React.createElement('div', { className: 'flex flex-col flex-1 h-full bg-base-light dark:bg-base rounded-b-2xl' },
                     React.createElement('div', { className: 'flex items-center justify-between p-4 border-b border-border-light dark:border-border flex-shrink-0' },
                        React.createElement('h3', { className: 'font-semibold text-primary-text-light dark:text-primary-text' }, `Prévia: ${multiAgent.name}`),
                        React.createElement('div', { className: 'flex items-center gap-2'},
                           React.createElement('button', { onClick: () => setIsLogOpen(!isLogOpen), className: `p-2 rounded-full text-secondary-text-light dark:text-secondary-text hover:bg-card-light dark:hover:bg-card ${isLogOpen ? 'bg-primary/10 dark:bg-primary/20 text-primary' : ''}`}, React.createElement(Icon, { name: 'terminal', className: 'h-4 w-4' })),
                           React.createElement('button', { onClick: () => clearChat(multiAgent.id), className: 'p-2 rounded-full text-secondary-text-light dark:text-secondary-text hover:bg-card-light dark:hover:bg-card hover:text-danger'}, React.createElement(Icon, { name: 'trash', className: 'h-4 w-4' }))
                        )
                    ),
                    React.createElement('div', { className: 'flex-1 p-4 overflow-y-auto' },
                        React.createElement('div', {className: 'space-y-6'},
                            chatHistory.map((msg, index) => React.createElement(ChatMessage, { key: index, msg: msg })),
                            isTyping && React.createElement(TypingIndicator)
                        ),
                        React.createElement('div', { ref: chatEndRef })
                    ),
                     React.createElement('div', { className: 'p-4 border-t border-border-light dark:border-border flex-shrink-0' },
                         React.createElement('div', { className: 'flex items-center gap-2 bg-input-bg-light dark:bg-input-bg border border-border-light dark:border-border rounded-lg px-2' },
                            React.createElement('input', {
                                type: 'text', placeholder: 'Digite sua mensagem...', value: input, onChange: e => setInput(e.target.value),
                                onKeyDown: e => e.key === 'Enter' && handleSend(), className: 'flex-1 bg-transparent py-2.5 px-2 text-sm outline-none'
                            }),
                            React.createElement('input', { type:'file', accept:'image/*', ref: imageInputRef, onChange: handleImageUpload, className: 'hidden' }),
                            React.createElement('button', { onClick: () => imageInputRef.current.click(), className: 'p-2 rounded-full text-secondary-text-light dark:text-secondary-text hover:bg-base-light dark:hover:bg-base' }, React.createElement(Icon, { name: 'image', className: 'h-5 w-5' })),
                            React.createElement('button', { onClick: handleMicClick, className: `p-2 rounded-full text-secondary-text-light dark:text-secondary-text hover:bg-base-light dark:hover:bg-base ${isListening ? 'text-danger' : ''}` }, React.createElement(Icon, { name: 'mic', className: `h-5 w-5 ${isListening ? 'animate-pulse' : ''}` })),
                            React.createElement('button', { onClick: handleSend, disabled: isTyping, className: 'p-2 rounded-full text-white bg-primary hover:bg-primary-hover disabled:bg-primary/50' }, React.createElement(Icon, { name: 'send', className: 'h-5 w-5' }))
                         )
                    )
                ),
                React.createElement(ExecutionLogPanel, { logs, isOpen: isLogOpen, onClose: () => setIsLogOpen(false) })
            );
        };
        
        const ExecutionLogPanel = ({ logs, isOpen, onClose }) => {
            const [expandedLog, setExpandedLog] = React.useState(null);
            
            if(!isOpen) return null;

            return React.createElement('div', { className: 'w-full sm:w-[400px] flex-col bg-card-light dark:bg-card border-l border-border-light dark:border-border rounded-r-2xl h-full fade-in hidden lg:flex' },
                React.createElement('div', { className: 'p-4 border-b border-border-light dark:border-border flex items-center justify-between' },
                     React.createElement('h4', {className: 'font-semibold text-primary-text-light dark:text-primary-text flex items-center gap-2'}, React.createElement(Icon, {name: 'terminal', className:'h-4 w-4'}), 'Logs de Execução'),
                     React.createElement('button', {onClick: onClose}, React.createElement(Icon, {name:'x', className:'h-4 w-4'}))
                ),
                React.createElement('div', { className: 'flex-1 p-2 overflow-y-auto' },
                    logs.map(log => React.createElement('div', { key: log.id, className: 'mb-1 text-sm' },
                        React.createElement('div', {
                            onClick: () => setExpandedLog(expandedLog === log.id ? null : log.id),
                            className: `flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-base-light dark:hover:bg-base ${log.status === 'error' ? 'text-danger' : ''}`
                        },
                            React.createElement('span', null, log.title),
                            React.createElement(Icon, { name: 'chevronsRight', className: `h-4 w-4 transition-transform ${expandedLog === log.id ? 'rotate-90' : ''}`})
                        ),
                        expandedLog === log.id && React.createElement('pre', { className: 'p-2 mt-1 bg-base-light dark:bg-base text-xs rounded-md overflow-x-auto' }, JSON.stringify(log.data, null, 2))
                    ))
                )
            );
        };

        const ChatMessage = ({ msg }) => {
            const isUser = msg.from === 'user';
            return React.createElement('div', { className: `flex gap-3 my-2 ${isUser ? 'justify-end' : 'justify-start'}` },
                !isUser && React.createElement('div', { className: 'w-8 h-8 rounded-full bg-primary flex items-center justify-center flex-shrink-0' }, React.createElement(Icon, { name: 'bot', className: 'h-5 w-5 text-white'})),
                React.createElement('div', { className: `p-3 rounded-2xl max-w-xs md:max-w-md shadow-md ${isUser ? 'bg-primary text-white rounded-br-none' : 'bg-card-light dark:bg-card text-primary-text-light dark:text-primary-text rounded-bl-none'}` },
                    msg.image && React.createElement('img', {src: msg.image, className:'rounded-lg mb-2'}),
                    msg.text && React.createElement('p', { className: 'text-sm whitespace-pre-wrap' }, msg.text)
                )
            );
        };
        
        const TypingIndicator = () => (
             React.createElement('div', { className: `flex gap-3 my-2 justify-start` },
                React.createElement('div', { className: 'w-8 h-8 rounded-full bg-primary flex items-center justify-center flex-shrink-0' }, React.createElement(Icon, { name: 'bot', className: 'h-5 w-5 text-white'})),
                React.createElement('div', { className: `p-3 rounded-2xl bg-card-light dark:bg-card flex items-center gap-1.5` },
                   React.createElement('span', { className: 'h-2 w-2 bg-secondary-text-light dark:bg-secondary-text rounded-full animate-bounce' }),
                   React.createElement('span', { className: 'h-2 w-2 bg-secondary-text-light dark:bg-secondary-text rounded-full animate-bounce [animation-delay:0.1s]' }),
                   React.createElement('span', { className: 'h-2 w-2 bg-secondary-text-light dark:bg-secondary-text rounded-full animate-bounce [animation-delay:0.2s]' })
                )
            )
        );

        const Footer = () => {
             const { multiAgents, setActiveTab } = useAppStore();
             const inputRef = React.useRef(null);

             const handleExport = () => {
                const dataStr = JSON.stringify(multiAgents, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', 'chatbot_config.json');
                linkElement.click();
                toast.success("Configuração exportada como JSON!");
             };

             const handleImportClick = () => {
                inputRef.current.click();
             }

             // In a real app, you'd update the zustand store here.
             const handleFileImport = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                       toast.success("Arquivo importado! (Simulação)");
                       console.log(JSON.parse(e.target.result));
                    };
                    reader.readAsText(file);
                }
             };

            return React.createElement('footer', { className: 'h-16 flex-shrink-0 bg-card-light dark:bg-card border-t border-border-light dark:border-border flex items-center justify-between px-6' },
                React.createElement('div', { className: 'hidden sm:flex items-center gap-2 text-sm text-secondary-text-light dark:text-secondary-text' },
                    React.createElement(Icon, { name: 'checkCircle', className: 'h-4 w-4 text-accent'}),
                    'Alterações salvas'
                ),
                React.createElement('div', { className: 'flex items-center gap-3 w-full sm:w-auto' },
                    React.createElement('input', {type:'file', ref:inputRef, onChange:handleFileImport, className:'hidden'}),
                    React.createElement('button', { onClick: handleImportClick, className: 'footer-btn' }, React.createElement(Icon, { name: 'login', className: 'h-4 w-4 sm:mr-2'}), React.createElement('span', {className:'hidden sm:inline'}, 'Importar')),
                    React.createElement('button', { onClick: handleExport, className: 'footer-btn' }, React.createElement(Icon, { name: 'fileJson', className: 'h-4 w-4 sm:mr-2'}), React.createElement('span', {className:'hidden sm:inline'},'Exportar')),
                    React.createElement('button', { onClick: () => toast.success("Configurações salvas!"), className: 'footer-btn' }, React.createElement(Icon, { name: 'save', className: 'h-4 w-4 sm:mr-2'}), React.createElement('span', {className:'hidden sm:inline'}, 'Salvar')),
                    React.createElement('button', { onClick: () => setActiveTab('preview'), className: 'footer-btn bg-primary text-white hover:bg-primary-hover' }, React.createElement(Icon, { name: 'testTube', className: 'h-4 w-4 sm:mr-2'}), React.createElement('span', {className:'hidden sm:inline'},'Testar Agente'))
                )
            );
        };
        
        // --- RENDER APP ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));

    </script>
</body>
</html>

